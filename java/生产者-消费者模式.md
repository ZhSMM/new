# 生产者-消费者模式

>生产者消费者模式并不是GOF提出的23种设计模式之一，23种设计模式都是建立在面向对象的基础之上的，但其实面向过程的编程中也有很多高效的编程模式，生产者消费者模式便是其中之一，它是我们编程过程中最常用的一种设计模式。

在实际的软件开发过程中，经常会碰到如下场景：某个模块负责产生数据，这些数据由另一个模块来负责处理（此处的模块是广义的，可以是类、函数、线程、进程等）。产生数据的模块，就形象地称为生产者；而处理数据的模块，就称为消费者。生产者和消费者之间通过缓冲区进行数据传递。

**优点**：

- 实现生产者与消费者的解耦；
- 支持并发；
- 支持忙闲不均；

**数据单元**：生产者与消费者传递数据的最小单元；

- 关联到业务对象

- 完整性：传递的数据要完整；
- 数据独立：指各单元数据之间没有依赖；
- 颗粒度：每次存、取数据单元的数量；

**分类**：

|  类别  | 生产者线程 | 消费者线程 |
| :----: | :--------: | :--------: |
| 单对单 |     1      |     1      |
| 单对多 |     1      |   N(N>1)   |
| 多对单 |   N(N>1)   |     1      |
| 多对多 |   N(N>1)   |   N(N>1)   |

## 阻塞队列

**阻塞方法**：一个方法或操作能够导致其执行线程被暂停（生命周期方法为BLOCKED或WAITING），就称该方法为阻塞方法或阻塞操作。阻塞方法/操作能够导致上下文切换。常见的阻塞方法：

- InputSream.read()^^
- ReentrantLock.lock()
- 申请内部锁等

**非阻塞方法**：一个方法/操作不会导致其执行线程暂停，相应的方法/操作称为非阻塞方法/操作。

**阻塞队列**：阻塞队列（BlockingQueue）是一个支持两个附加操作的队列。这两个附加的操作支持阻塞的插入和移除方法：

- 支持阻塞的插入方法：意思是当队列满时，队列会阻塞插入元素的线程，直到队列不满；
- 支持阻塞的移除方法：意思是在队列为空时，获取元素的线程会等待队列变为非空。

> 阻塞队列按照存储空间容量是否受限分成有界队列和无界队列。有界队列的存储容量限制由应用程序限定；无界队列的最大存储容量为Integer.MAX_VALUE(2^31^-1)个元素。
>
> 往队列中存入一个元素（对象）称为put操作，取出一个元素称为take操作。

阻塞队列常用于生产者和消费者的场景，生产者是向队列里添加元素的线程，消费者是从队列里取元素的线程。阻塞队列就是生产者用来存放元素、消费者用来获取元素的容器。

在阻塞队列不可用时，这两个附加操作提供了4种处理方式：

| 方法/处理方式 | 抛出异常  | 返回特殊值 | 一直阻塞 |      超时退出      |
| :-----------: | :-------: | :--------: | :------: | :----------------: |
|     插入      |  add(e)   |  offer(e)  |  put(e)  | offer(e,time,unit) |
|     删除      | remove()  |   poll()   |  take()  |  poll(time,unit)   |
|     检查      | element() |   peek()   |    无    |         无         |

抛出异常：

- 是指当阻塞队列满时候，再往队列里插入元素，会抛出 IllegalStateException("Queue full") 异常；
- 当队列为空时，从队列里获取元素时会抛出 NoSuchElementException 异常 。

返回特殊值：

- 插入方法会返回是否成功，成功则返回 true；
- 移除方法，则是从队列里拿出一个元素，如果没有则返回 null；

一直阻塞：

- 当阻塞队列满时，如果生产者线程往队列里 put 元素，队列会一直阻塞生产者线程，直到拿到数据，或者响应中断退出；
- 当队列空时，消费者线程试图从队列里 take 元素，队列也会阻塞消费者线程，直到队列可用。

超时退出：

- 当阻塞队列满时，队列会阻塞生产者线程一段时间，如果超过一定的时间，生产者线程就会退出。

> 如果是无界阻塞队列，队列不可能会出现满的情况，所以使用put或offer方法永远不会被阻塞，而且使用offer方法时，该方法永远返回true.

JDK1.8实现的阻塞队列：

| ArrayBlockingQueue    | 数组实现的有界阻塞队列       |
| :-------------------- | :--------------------------- |
| LinkedBlockingQueue   | 链表实现的有界阻塞队列       |
| PriorityBlockingQueue | 支持优先级排序的无界阻塞队列 |
| DelayQueue            | 优先级队列实现的无界阻塞队列 |
| SynchronousQueue      | 不存储元素的阻塞队列         |
| LinkedTransferQueue   | 链表实现的无界阻塞队列       |
| LinkedBlockingDeque   | 链表实现的双向阻塞队列       |

