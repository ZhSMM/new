# UTF-8编码规则

Unicode字符集，属于编码方案，并没有约定如何存储；Unicode的实现：UTF-8、UTF-16、UTF-32；

Unicode相当于一本字典，将全世界的字符定义在一个集合里，这么多的字符不是一次性定义的，而是分区定义，每个区可以放置2^16^(65536)个字符，称为一个平面（plane）。目前，一共有17（2^5^）个平面，也就是说，整个Unicode字符集的大小现在是2^21^。

前面的2^16^个字符位称为基本平面（BMP），码点范围从0-2^16^-1，写成 16 进制就是从 U+0000 到 U+FFFF。所有最常见的字符都放在这个平面，这是 Unicode 最先定义和公布的一个平面。剩下的字符都放在辅助平面（简称 SMP ），码点范围从 U+010000 到 U+10FFFF。

## UTF-8

属于可变长度的编码，可以使用1-4个字节表示一个字符，编码规则如下：

- 对于单个字节的字符，第一位设为 0，后面的 7 位对应这个字符的 Unicode 码点。因此，对于英文中的 0 - 127 号字符，与 ASCII 码完全相同。这意味着 ASCII 码那个年代的文档用 UTF-8 编码打开完全没有问题。
- 对于需要使用 N 个字节来表示的字符（N > 1），第一个字节的前 N 位都设为 1，第 N + 1 位设为0，剩余的 N - 1 个字节的前两位都设位 10，剩下的二进制位则使用这个字符的 Unicode 码点来填充。

不同字符占有的字节数：

- 128 个 ASCII 字符（Unicode 范围由 U+0000 至  U+007F）只需一个字节；
- 带有变音符号的拉丁文、希腊文、西里尔字母、亚美尼亚语、希伯来文、阿拉伯文、叙利亚文及马尔代夫语（Unicode  范围由 U+0080 至 U+07FF）需要二个字节；
- 其他基本多文种平面（BMP）中的字符（CJK属于此类-Qieqie注）使用三个字节；
- 其他  Unicode 辅助平面的字符使用四字节编码。

对应关系：

| Unicode 十六进制码点范围 | UTF-8 二进制                        |
| ------------------------ | ----------------------------------- |
| 0000 0000 - 0000 007F    | 0xxxxxxx                            |
| 0000 0080 - 0000 07FF    | 110xxxxx 10xxxxxx                   |
| 0000 0800 - 0000 FFFF    | 1110xxxx 10xxxxxx 10xxxxxx          |
| 0001 0000 - 0010 FFFF    | 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx |

编码：

- “汉”的 Unicode 码点是 0x6c49（110 1100 0100 1001），通过上面的对照表可以发现，`0x0000 6c49` 位于第三行的范围，那么得出其格式为 `1110xxxx 10xxxxxx 10xxxxxx`；
- 从“汉”的二进制数最后一位开始，从后向前依次填充对应格式中的 x，多出的 x 用 0 补上；
- “汉”的 UTF-8 编码为 `11100110 10110001 10001001`，转换成十六进制就是 `0xE6 0xB7 0x89`；

解码：如果一个字节的第一位是 0 ，则说明这个字节对应一个字符；如果一个字节的第一位1，那么连续有多少个 1，就表示该字符占用多少个字节。

## UTF-16

UTF-16 编码介于 UTF-32 与 UTF-8 之间，同时结合了定长和变长两种编码方法的特点。

编码规则：

基本平面的字符占用 2 个字节，辅助平面的字符占用 4 个字节。也就是说，UTF-16 的编码长度要么是 2 个字节（U+0000 到 U+FFFF），要么是 4 个字节（U+010000 到 U+10FFFF）。那么如何区分是两个字节还是四个字节的字符？

巧妙的设定：

- 在基本平面内，从 U+D800 到 U+DFFF 是一个空段，即这些码点不对应任何字符。因此，这个空段可以用来映射辅助平面的字符。

- 辅助平面的字符位共有 `2^20` 个，因此表示这些字符至少需要 20 个二进制位。UTF-16 将这 20  个二进制位分成两半，前 10 位映射在 U+D800 到 U+DBFF，称为高位（H），后 10 位映射在 U+DC00 到  U+DFFF，称为低位（L）。这意味着，一个辅助平面的字符，被拆成两个基本平面的字符表示。
- 因此，当我们遇到两个字节，且它的码点在 U+D800 到 U+DBFF 之间，就可以断定，紧跟在后面的两个字节的码点，应该在 U+DC00 到 U+DFFF 之间，这四个字节必须放在一起解读。

汉字"𠮷"为例，说明 UTF-16 编码方式是如何工作的：

"𠮷"的 Unicode 码点为 `0x20BB7`，该码点显然超出了基本平面的范围（0x0000 - 0xFFFF），因此需要使用四个字节表示。

- 用 `0x20BB7 - 0x10000` 计算出超出的部分，然后将其用 20 个二进制位表示（不足前面补 0 ），结果为`0001000010 1110110111`；
- 将前 10 位映射到 U+D800 到 U+DBFF 之间，后 10 位映射到 U+DC00 到 U+DFFF 即可；
- U+D800 对应的二进制数为 1101100000000000，直接填充后面的 10 个二进制位即可，得到 1101100001000010，转成 16 进制数则为 0xD842；
- 低位为 `0xDFB7`。因此得出汉字"𠮷"的 UTF-16 编码为 `0xD842 0xDFB7`；

```javascript
// 辅助平面字符转换公式
H = Math.floor((c-0x10000) / 0x400)+0xD800
L = (c - 0x10000) % 0x400 + 0xDC00
```

## 不同字符集中英文字节数对照

|  字符编码  | 英文字母 | 中文字母 |
| :--------: | :------: | :------: |
|   GB2312   |    1     |    2     |
|    GBK     |    1     |    2     |
|  GB18030   |    1     |    2     |
| ISO-8859-1 |    1     |    1     |
|   UTF-8    |    1     |    3     |
|   UTF-16   |    4     |    4     |
|  UTF-16BE  |    2     |    2     |
|  UTF-16LE  |    2     |    2     |

