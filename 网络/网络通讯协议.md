# 网络通讯协议

互联网的核心是一些列的协议，总称“互联网协议”。

## 分层模型

互联网的实现分为好几层，每一层都有每一层的功能，每一层都靠下一层支持。分层模型有分7层、4层，这里分5层，从上层到下层依次为：

- 应用层（Application Layer）
- 传输层（Transport Layer）
- 网络层（Network Layer）
- 链接层（Link Layer）
- 实体层（Physical Layer）

### 层与协议

每一层都是为了完成一种功能。为了实现这些功能，就需要大家都遵守共同的规则。大家都遵守的规则，就叫做"协议"（protocol）。 互联网的每一层，都定义了很多协议。这些协议的总称，就叫做"互联网协议"（Internet Protocol Suite）

### 实体层

将电脑连接起来的物理硬件，比如光纤、电缆、双绞线、无线电波等方式用来传输0/1的电信号。

### 链接层

 单纯的0和1没有任何意义，必须规定解读方式：多少个电信号算一组？每个信号位有何意义？

链接层，定义在实体层的上方，确定了0/1的分组方式。

#### 以太网协议

以太网协议（Ethernet）：一组电信号构成一个数据包，叫做**帧**（Frame）。每一帧分为两个部分：

- 标头（Head）：
  - 包含数据包的一些说明项，比如发送者、接受者、数据类型等等；
  - 标头的长度，固定为18字节。
- 数据（Data）：
  - 数据包的具体内容；
  - 数据长度最短为46字节，最长为1500字节。
- 帧最短字节为64字节，最长为1518字节，如果数据过长，就必须分割成多个帧进行发送。

#### MAC地址

 以太网规定，连入网络的所有设备，都必须具有"网卡"接口。数据包必须是从一块网卡，传送到另一块网卡。网卡的地址，就是数据包的发送地址和接收地址，这叫做MAC地址。

每一块网卡出厂的时候，都有一个全世界独一无二的MAC地址，长度是48个二进制位，通常用12个六进制数表示。

- 前6个十六进制数是厂商编号；
- 后6个是该厂商的网卡流水号。

#### 广播

- 以太数据包必须知道接收方的MAC的地址，才能正确发送（通过ARP协议）；
- 有了以太地址，以太网就能通过向本网络所有的计算机发送数据包，然后让接受的每台计算机通过读取数据包的标头，找到接收方的MAC地址，与自身比较，相同则后续处理，不同则丢弃这个包，这种发送方式叫**广播（broadcasting）**。

链路层在多台计算机之间传送数据的条件：

- 数据包定义；
- 网卡的MAC地址；
- 广播的发送方式；

### 网络层

互联网是通过不同的子网络组成的一个巨型网络，在不同的子网络，广播无法传输。因此必须找到一种方法，能够区分哪些MAC地址属于同一个子网络，哪些不是。如果是同一个子网络，就采用广播方式发送，否则就采用"路由"方式发送。（"路由"的意思，就是指如何向不同的子网络分发数据包）遗憾的是，MAC地址本身无法做到这一点。它只与厂商有关，与所处网络无关。

**网络层**：引进一套新的地址，是我们能够区分不同的计算机是否属于同一个子网络。这套地址就叫做"网络地址"，简称"网址"。

于是，"网络层"出现以后，每台计算机有了两种地址，一种是MAC地址，另一种是网络地址。两种地址之间没有任何联系，MAC地址是绑定在网卡上的，网络地址则是管理员分配的，它们只是随机组合在一起。

 网络地址帮助我们确定计算机所在的子网络，MAC地址则将数据包送到该子网络中的目标网卡。因此，从逻辑上可以推断，必定是先处理网络地址，然后再处理MAC地址。

#### IP协议

规定网络地址的协议，叫做IP协议，定义的地址，叫做IP地址。目前采用的使IP协议第4版，简称IPv4。

IPv4规定，网络地址由32个二进制位组成：

- 习惯上分四段的十进制数表示IP地址，从0.0.0.0到255.255.255.255；
- 该IP地址分两个部分，前一部分代表网络，后一部分代表主机；
- 处于同一个子网络的电脑，它们IP地址的网络部分必定是相同的；

由于单看IP地址，无法区分网络部分到底是前24位，还是前16位，甚至是前28位，因此引入**子网掩码**（subnet mask）。

**子网掩码**：就是表示子网络特征的一个参数。它在形式上等同于IP地址，也是一个32位二进制数字，它的网络部分全部为1，主机部分全部为0。比如，IP地址172.16.254.1，如果已知网络部分是前24位，主机部分是后8位，那么子网络掩码就是11111111.11111111.11111111.00000000，写成十进制就是255.255.255.0。

通过子网掩码判断任意两个IP是否在同一子网络：通过IP地址与子网掩码进行AND运算，比较结果，相同即说明在同一网络，否则就不是。

IP协议作用：为每一台计算机分配IP地址，确定哪些地址在同一子网络。

#### IP数据包

根据IP协议发送的数据包，叫IP数据包。

- 不需要修改以太数据包的结构，**直接将IP数据包放入以太数据包的数据（Data）部分**。

- IP数据包分为标头（Head）和数据（Data）两部分
  - 标头：主要包括版本、长度、IP地址等信息；
  - "数据"部分则是IP数据包的具体内容；
- IP数据包标头长度20-60字节，整个数据包总长度65535字节。而以太数据包的数据部分总长只有1500字节，因此当IP数据包长度超过1500字节时，需要分割成多个以太数据包分开发送。

#### ARP协议

因为IP数据包是放在以太数据包的数据部分发送的，因此必须知道两个地址：

- MAC地址；
- IP地址；

IP地址是已知的，而MAC地址未知，因此需要一种机制，能够从IP得到MAC地址，这分两种情况：

- 如果两主机不在同一子网络，那么事实上没有办法得到对方的MAC地址，只能把数据包传送到两个子网络连接处的"网关"（gateway），让网关去处理；
- 如果两台主机在同一个子网络，那么我们可以用ARP协议，得到对方的MAC地址。
  - ARP协议也是发出一个数据包（包含在以太网数据包中），其中包含它所要查询主机的IP地址，在对方的MAC地址这一栏，填的是FF:FF:FF:FF:FF:FF，表示这是一个"广播"地址。它所在子网络的每一台主机，都会收到这个数据包，从中取出IP地址，与自身的IP地址进行比较。如果两者相同，都做出回复，向对方报告自己的MAC地址，否则就丢弃这个包。

### 传输层

有了MAC与IP地址，能够在互联网任意两台主机建立通信。然而，同一主机存在多个程序使用网络，我们需要一个参数来表明这个数据包供那个应用程序/进程使用，这个参数叫做**端口**（port）。

- 端口是每一个使用网卡的程序的编号，每个数据包发送到主机的特定端口，特定的程序就能获取到自己所需要的数据；
- 端口是0-65535之间的一个整数，正好16个二进制位。其中，0-1023端口系统占用，用户只能选择大于1023的端口；

传输层的功能，就是建立”端口到端口“的通信，相比较之下，网络层的功能是建立”主机到主机“的通信，只要确定主机和端口，就能实现程序之间的交流。因此，Unix系统就把主机+端口，叫做”**套接字**“（socket），有了套接字，就能进行应用程序的开发。

#### UDP协议

现在，我们必须在数据包中加入端口信息，这就需要新的协议。最简单的实现叫做UDP协议，它的格式几乎就是在数据前面，加上端口号。

**UDP数据包**：由标头和数据组成，总长不超过65535字节，刚好放入IP数据包的数据部分；

- 标头：（8个字节）定义了发出端口和接受端口；
- 数据：具体的内容；

- 优点是比较简单，容易实现，但是缺点是可靠性较差；一旦数据包发出，无法知道对方是否收到。

**TCP协议**：

为了解决UDP协议的可靠性差问题，提出了TCP协议：这个协议非常复杂，但可以近似认为，它就是有确认机制的UDP协议，每发出一个数据包都要求确认。如果有一个数据包遗失，就收不到确认，发出方就知道有必要重发这个数据包了。

- 优点：确保数据不会遗失；
- 缺点：过程复杂，实现困难，小号较多的资源；
- TCP数据包和UDP数据包一样，都是内嵌在IP数据包的"数据"部分。TCP数据包没有长度限制，理论上可以无限长，但是为了保证网络的效率，通常TCP数据包的长度不会超过IP数据包的长度，以确保单个TCP数据包不必再分割。

### 应用层

应用程序收到"传输层"的数据，接下来就要进行解读。由于互联网是开放架构，数据来源五花八门，必须事先规定好格式，否则根本无法解读。"应用层"的作用，就是规定应用程序的数据格式。

 举例来说，TCP协议可以为各种各样的程序传递数据，比如Email、WWW、FTP等等。那么，必须有不同协议规定电子邮件、网页、FTP数据的格式，这些应用程序协议就构成了"应用层"。这是最高的一层，直接面对用户。它的数据就放在TCP数据包的"数据"部分。

#### DNS协议

负责从网址到IP的转换；

#### HTTP协议

浏览网页用的HTTP协议，整个数据包结构如下：

- 以太网标头；
- IP标头；
- TCP标头；
- HTTP数据包；

### 总结

因此，以太数据包变成了如下格式：

Head（以太网标头）、Head（IP标头）、Head（TCP标头）、Data（应用层数据包）。

发送该数据包，必须知道两个地址：

- 对方的IP地址；
- 对方的MAC地址；

有了这两个地址，数据包才能准确送到接收者手中。但是，前面说过，MAC地址有局限性，如果两台电脑不在同一个子网络，就无法知道对方的MAC地址，必须通过网关（gateway）转发。

因此数据包的目标地址分两种情况：

| 场景       | 数据包地址                  |
| ---------- | --------------------------- |
| 同一个子网 | 对方的MAC和IP地址           |
| 非同一子网 | 网关的MAC地址，对方的IP地址 |

## 用户上网设置

新电脑联网的设置，四个参数：

- 本机IP地址
- 子网掩码
- 网关IP
- DNS的IP

### 本机IP

#### 静态IP地址

如果本机IP是固定的，即电脑每次开机都会分配到同样的IP地址，这种情况叫做”静态IP地址上网“。 

#### 动态IP地址

指计算机开机后，会自动分配到一个IP地址，不用人为设定。它使用的协议叫做DHCP协议。

这个协议规定，每一个子网络中，有一台计算机负责管理本网络的所有IP地址，它叫做"DHCP服务器"。新的计算机加入网络，必须向"DHCP服务器"发送一个"DHCP请求"数据包，申请IP地址和相关的网络参数。

 前面说过，如果两台计算机在同一个子网络，必须知道对方的MAC地址和IP地址，才能发送数据包。但是，新加入的计算机不知道这两个地址，怎么发送数据包呢？DHCP协议做了一些巧妙的规定。

#### DHCP协议

属于应用层协议，建立在UDP协议之上，数据包如下：

Head（以太网标头）、Head（IP标头）、Head（UDP标头）、Data（DHCP数据包）

- **最前面的"以太网标头"：**设置发出方（本机）的MAC地址和接收方（DHCP服务器）的MAC地址。前者就是本机网卡的MAC地址，后者这时不知道，就填入一个广播地址：FF-FF-FF-FF-FF-FF。
- **后面的"IP标头"：**设置发出方的IP地址和接收方的IP地址。这时，对于这两者，本机都不知道。于是，发出方的IP地址就设为0.0.0.0，接收方的IP地址设为255.255.255.255。
- **最后的"UDP标头"：**设置发出方的端口和接收方的端口。这一部分是DHCP协议规定好的，发出方是68端口，接收方是67端口。

这个数据包构造完成后，就可以发出了。以太网是广播发送，同一个子网络的每台计算机都收到了这个包。因为接收方的MAC地址是FF-FF-FF-FF-FF-FF，看不出是发给谁的，所以每台收到这个包的计算机，还必须分析这个包的IP地址，才能确定是不是发给自己的。当看到发出方IP地址是0.0.0.0，接收方是255.255.255.255，于是DHCP服务器知道"这个包是发给我的"，而其他计算机就可以丢弃这个包。

接下来，DHCP服务器读出这个包的数据内容，分配好IP地址，发送回去一个"DHCP响应"数据包。这个响应包的结构也是类似的，以太网标头的MAC地址是双方的网卡地址，IP标头的IP地址是DHCP服务器的IP地址（发出方）和255.255.255.255（接收方），UDP标头的端口是67（发出方）和68（接收方），分配给请求端的IP地址和本网络的具体参数则包含在Data部分。

新加入的计算机收到这个响应包，于是就知道了自己的IP地址、子网掩码、网关地址、DNS服务器等等参数。

### 网址访问实例

1. 在浏览器输入网址”www.baidu.com“，意味着浏览器要向百度发送一个数据包；
2. 向DNS服务器发送数据包（53端口),数据包信息如下顺序:

   - 以太网标头;
- IP标头
   - UDP标头
- DNS数据包
3. DNS返回百度IP地址；
4. 通过子网掩码计算此IP是否与本机在同一网络，否则必须通过网关转发；
5. 应用层协议HTTP
6. TCP
7. IP
8. 以太网：MAC

